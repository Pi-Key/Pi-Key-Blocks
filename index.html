<!--
 Copyright (C) 2023 antoine
 
 This file is part of PiKey-blocks.
 
 PiKey-blocks is free software: you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
 the Free Software Foundation, either version 3 of the License, or
 (at your option) any later version.
 
 PiKey-blocks is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU General Public License for more details.
 
 You should have received a copy of the GNU General Public License
 along with PiKey-blocks.  If not, see <http://www.gnu.org/licenses/>.
-->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PiKey Blocks</title>
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <script src="https://unpkg.com/blockly/javascript_compressed.js"></script>
</head>
<style>
    :root {
        padding: 0;
        margin: 0;
    }

    table {
        height: calc(100vh - 1.25rem);
        width: calc(100vw - 1.25rem);
        margin-top: 0.25rem;
        margin-left: 0.25rem;
    }

    button {
        position: absolute;
        right: 0.63rem;
        top: 0.63rem;
        border: thin solid black;
        border-radius: 0;
        border-bottom-left-radius: 0.5rem;
        background: white;
        height: 2.5rem;
        width: 10rem;
        z-index: 10;
        cursor: pointer;
        outline: thin solid white;
        outline-offset: -0.1rem;
        transition: 0.25s cubic-bezier(0.6, 0.04, 0.98, 0.335);
    }

    button:hover {
        background: black;
        outline-offset: -0.5rem;
        color: white;
        font-weight: bolder;
    }

    .blocklyMainBackground {
        stroke-width: 1;
        stroke: black;
    }
</style>

<body>
    <button onclick="exportToDuckyscript">Export</button>
    <table>
        <tr>
            <td id="blocklyArea">
            </td>
        </tr>
    </table>

    <div id="blocklyDiv" style="position: absolute"></div>

    <script defer>
        const blocklyArea = document.getElementById('blocklyArea');
        const blocklyDiv = document.getElementById('blocklyDiv');
        var toolbox = `
        <xml xmlns="https://developers.google.com/blockly/xml">
            <category name="DuckyScript" colour="#5C81A6">
                <block type="type_string"></block>
                <block type="delay"></block>
                <block type="repeat"></block>
                <block type="press_key"></block>
                <block type="command_separator"></block>
            </category>
        </xml>
        `;

        Blockly.defineBlocksWithJsonArray([
            {
                "type": "type_string",
                "message0": "Type %1",
                "args0": [
                    {
                        "type": "input_value",
                        "name": "STRING",
                        "check": "String"
                    }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 230,
                "tooltip": "Types the given string",
                "helpUrl": ""
            },
            {
                "type": "delay",
                "message0": "Delay %1 ms",
                "args0": [
                    {
                        "type": "field_number",
                        "name": "MS",
                        "value": 100,
                        "min": 0
                    }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 230,
                "tooltip": "Pauses the script for the given number of milliseconds",
                "helpUrl": ""
            },
            {
                "type": "press_key",
                "message0": "Press %1",
                "args0": [
                    {
                        "type": "field_dropdown",
                        "name": "KEY",
                        "options": [
                            ["ENTER", "ENTER"],
                            ["ESC", "ESC"],
                            ["TAB", "TAB"],
                            ["SHIFT", "SHIFT"],
                            ["ALT", "ALT"],
                            ["CTRL", "CTRL"],
                            ["DELETE", "DELETE"],
                            ["HOME", "HOME"],
                            ["END", "END"],
                            ["PAGE_UP", "PAGE_UP"],
                            ["PAGE_DOWN", "PAGE_DOWN"],
                            ["UP", "UP"],
                            ["DOWN", "DOWN"],
                            ["LEFT", "LEFT"],
                            ["RIGHT", "RIGHT"]
                        ]
                    }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 230,
                "tooltip": "Presses the given key",
                "helpUrl": ""
            },
            {
                "type": "repeat",
                "message0": "Repeat %1 times %2",
                "args0": [
                    {
                        "type": "field_number",
                        "name": "TIMES",
                        "value": 2,
                        "min": 1
                    },
                    {
                        "type": "input_statement",
                        "name": "COMMANDS"
                    }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 230,
                "tooltip": "Repeats the given set of commands the specified number of times",
                "helpUrl": ""
            },
            {
                "type": "command_separator",
                "message0": "%1 %2",
                "args0": [
                    {
                        "type": "input_value",
                        "name": "COMMAND_1",
                        "check": ["Command", "null"]
                    },
                    {
                        "type": "input_value",
                        "name": "COMMAND_2",
                        "check": ["Command", "null"]
                    }
                ],
                "inputsInline": true,
                "output": "Command",
                "colour": 230,
                "tooltip": "Executes two commands in sequence",
                "helpUrl": ""
            }
        ]);

        function getCode() {
            var code = '';
            var workspaceBlocks = workspace.getTopBlocks();
            for (var i = 0; i < workspaceBlocks.length; i++) {
                var block = workspaceBlocks[i];
                var functionName = block.getFieldValue('NAME');
                switch (functionName) {
                    case 'STRING':
                        var text = Blockly.JavaScript.valueToCode(block, 'VALUE', Blockly.JavaScript.ORDER_ATOMIC);
                        code += text + '\n';
                        break;
                    case 'DELAY':
                        var time = Blockly.JavaScript.valueToCode(block, 'VALUE', Blockly.JavaScript.ORDER_ATOMIC);
                        code += 'DELAY ' + time + '\n';
                        break;
                    case 'REPEAT':
                        var count = Blockly.JavaScript.valueToCode(block, 'TIMES', Blockly.JavaScript.ORDER_ATOMIC);
                        var repeatCode = getCodeFromBlocks(block.getChildren());
                        code += 'REPEAT ' + count + ' {\n' + repeatCode + '}\n';
                        break;
                    case 'TYPE':
                        var text = Blockly.JavaScript.valueToCode(block, 'VALUE', Blockly.JavaScript.ORDER_ATOMIC);
                        code += 'TYPE ' + text + '\n';
                        break;
                    case 'PRESS':
                        var text = Blockly.JavaScript.valueToCode(block, 'VALUE', Blockly.JavaScript.ORDER_ATOMIC);
                        code += 'PRESS ' + text + '\n';
                        break;
                    case 'RELEASE':
                        var text = Blockly.JavaScript.valueToCode(block, 'VALUE', Blockly.JavaScript.ORDER_ATOMIC);
                        code += 'RELEASE ' + text + '\n';
                        break;
                    default:
                        break;
                }
            }
            return code;
        }

        function getCodeFromBlocks(blocks) {
            var code = '';
            for (var i = 0; i < blocks.length; i++) {
                var block = blocks[i];
                var functionName = block.getFieldValue('NAME');
                switch (functionName) {
                    case 'STRING':
                        var text = Blockly.JavaScript.valueToCode(block, 'VALUE', Blockly.JavaScript.ORDER_ATOMIC);
                        code += text + '\n';
                        break;
                    case 'DELAY':
                        var time = Blockly.JavaScript.valueToCode(block, 'VALUE', Blockly.JavaScript.ORDER_ATOMIC);
                        code += 'DELAY ' + time + '\n';
                        break;
                    case 'TYPE':
                        var text = Blockly.JavaScript.valueToCode(block, 'VALUE', Blockly.JavaScript.ORDER_ATOMIC);
                        code += 'TYPE ' + text + '\n';
                        break;
                    case 'PRESS':
                        var text = Blockly.JavaScript.valueToCode(block, 'VALUE', Blockly.JavaScript.ORDER_ATOMIC);
                        code += 'PRESS ' + text + '\n';
                        break;
                    case 'RELEASE':
                        var text = Blockly.JavaScript.valueToCode(block, 'VALUE', Blockly.JavaScript.ORDER_ATOMIC);
                        code += 'RELEASE ' + text + '\n';
                        break;
                    default:
                        break;
                }
            }
            return code;
        }



        function exportToDuckyscript() {
            var code = Blockly.Duckyscript.workspaceToCode(workspace);
            var blob = new Blob([code], { type: "text/plain;charset=utf-8" });
            saveAs(blob, "payload.txt");
        }

        var workspace = Blockly.inject(blocklyDiv,
            {
                toolbox: toolbox,
                trashcan: true,
                grid:
                {
                    spacing: 20,
                    length: 3,
                    colour: '#ccc',
                    snap: true
                },
                scrollbars: true
            });

        const onresize = function (e) {
            let element = blocklyArea;
            let x = 0;
            let y = 0;
            do {
                x += element.offsetLeft;
                y += element.offsetTop;
                element = element.offsetParent;
            } while (element);
            blocklyDiv.style.left = x + 'px';
            blocklyDiv.style.top = y + 'px';
            blocklyDiv.style.width = blocklyArea.offsetWidth + 'px';
            blocklyDiv.style.height = blocklyArea.offsetHeight + 'px';
            Blockly.svgResize(workspace);
        };
        window.addEventListener('resize', onresize, false);
        onresize();
    </script>


</body>

</html>